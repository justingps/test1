<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e3a8a;
            --accent-color: #db2777;
            --light-color: #e0e7ff;
            --dark-color: #111827;
            --success-color: #059669;
            --warning-color: #d97706;
            --info-color: #2563eb;
            --background-color: #e5e7eb;
            --card-bg: #e5e7eb;
            --text-color: #1f2a44;
            --text-light: #6b7280;
            --border-color: #d1d5db;
            --shadow-light: #ffffff;
            --shadow-dark: #b0b7c3;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1440px;
            margin: 1.5rem auto;
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 6px 6px 12px var(--shadow-dark),
                        -6px -6px 12px var(--shadow-light);
        }

        .header {
            background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo {
            height: 60px;
            border-radius: 8px;
        }

        .company-info {
            font-family: 'Roboto', sans-serif;
            font-size: 0.9rem;
            line-height: 1.6;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .company-info strong {
            font-weight: 500;
        }

        .logout-button {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: white;
            background: var(--warning-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Roboto', sans-serif;
        }

        .logout-button:hover {
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tabs {
            display: flex;
            background-color: var(--card-bg);
            padding: 0.5rem;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            color: var(--text-light);
            transition: all 0.2s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.3rem;
            border-radius: 8px;
            background: var(--card-bg);
            box-shadow: 4px 4px 8px var(--shadow-dark),
                        -4px -4px 8px var(--shadow-light);
        }

        .tab:hover {
            background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tab.active {
            background: var(--card-bg);
            color: var(--primary-color);
            font-weight: 500;
            box-shadow: inset 4px 4px 8px var(--shadow-dark),
                        inset -4px -4px 8px var(--shadow-light);
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        h1, h2, h3 {
            color: var(--dark-color);
            margin-top: 0;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -0.3rem;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
        }

        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin: 1rem 0;
            padding: 1rem;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark),
                        inset -4px -4px 8px var(--shadow-light);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-width: 180px;
            position: relative;
        }

        .filter-label {
            font-weight: 500;
            color: var(--dark-color);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .date-picker, .area-select, .wi-input {
            padding: 0.6rem;
            font-size: 0.85rem;
            border: none;
            border-radius: 8px;
            background-color: var(--card-bg);
            font-family: 'Inter', sans-serif;
            flex: 1;
            box-shadow: inset 2px 2px 4px var(--shadow-dark),
                        inset -2px -2px 4px var(--shadow-light);
            transition: all 0.2s ease;
        }

        .date-picker:focus, .area-select:focus, .wi-input:focus {
            outline: none;
            box-shadow: inset 1px 1px 2px var(--shadow-dark),
                        inset -1px -1px 2px var(--shadow-light),
                        0 0 0 2px var(--primary-color);
        }

        .no-data {
            color: var(--text-light);
            font-style: italic;
            margin: 1.5rem 0;
            text-align: center;
            padding: 1.5rem;
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: inset 4px 4px 8px var(--shadow-dark),
                        inset -4px -4px 8px var(--shadow-light);
        }

        .work-group {
            margin-bottom: 1.5rem;
            border-radius: 12px;
            background-color: var(--card-bg);
            box-shadow: 6px 6px 12px var(--shadow-dark),
                        -6px -6px 12px var(--shadow-light);
        }

        .work-group-header {
            background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .work-group-title {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .work-group-id {
            background-color: var(--card-bg);
            color: var(--primary-color);
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.8rem;
            box-shadow: inset 2px 2px 4px var(--shadow-dark),
                        inset -2px -2px 4px var(--shadow-light);
        }

        .work-description {
            white-space: pre-line;
            background-color: var(--card-bg);
            padding: 1rem;
            margin: 0;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .resource-table {
            width: 100%;
            border-collapse: collapse;
        }

        .resource-table th {
            background-color: var(--light-color);
            color: var(--dark-color);
            padding: 0.7rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .resource-table td {
            padding: 0.7rem;
            font-size: 0.8rem;
        }

        .resource-table tr:last-child td {
            border-bottom: none;
        }

        .resource-table tr:hover {
            background-color: rgba(37, 99, 235, 0.1);
        }

        .summary-card {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 0.8rem;
            margin: 1rem;
        }

        .summary-item {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 0.8rem;
            box-shadow: 4px 4px 8px var(--shadow-dark),
                        -4px -4px 8px var(--shadow-light);
        }

        .summary-label {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .summary-value {
            font-weight: 700;
            color: var(--dark-color);
            font-size: 1.1rem;
        }

        .chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 6px 6px 12px var(--shadow-dark),
                        -6px -6px 12px var(--shadow-light);
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
            color: var(--dark-color);
            text-align: center;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 1rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.8rem;
        }

        .data-table th, .data-table td {
            padding: 0.7rem;
            text-align: left;
            font-size: 0.8rem;
        }

        .data-table th {
            background-color: var(--light-color);
            font-weight: 600;
            color: var(--dark-color);
        }

        .data-table tr:hover {
            background-color: rgba(37, 99, 235, 0.1);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.4rem;
        }

        .status-active {
            background-color: var(--success-color);
        }

        .status-inactive {
            background-color: var(--warning-color);
        }

        .daily-summary {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 6px 6px 12px var(--shadow-dark),
                        -6px -6px 12px var(--shadow-light);
        }

        .daily-summary h3 {
            margin: 0 0 0.8rem;
            font-size: 1rem;
            color: var(--dark-color);
        }

        .daily-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 0.8rem;
        }

        .daily-summary-item {
            background-color: var(--card-bg);
            padding: 0.8rem;
            border-radius: 8px;
            box-shadow: 4px 4px 8px var(--shadow-dark),
                        -4px -4px 8px var(--shadow-light);
        }

        .daily-summary-area {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        .daily-summary-stats {
            display: flex;
            justify-content: space-between;
            gap: 0.4rem;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark),
                        inset -4px -4px 8px var(--shadow-light);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s ease-in-out infinite;
            margin-bottom: 0.8rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: 0.4rem;
        }

        .loading-subtext {
            color: var(--text-light);
            font-size: 0.8rem;
            margin-top: 0.3rem;
            font-style: italic;
        }

        .summary-date-filter {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark),
                        inset -4px -4px 8px var(--shadow-light);
        }

        .summary-date-label {
            font-weight: 500;
            color: var(--dark-color);
            font-size: 0.85rem;
        }

        .login-container {
            max-width: 400px;
            padding: 2rem;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 6px 6px 12px var(--shadow-dark),
                        -6px -6px 12px var(--shadow-light);
            text-align: center;
        }

        .login-logo {
            max-width: 100px;
            margin-bottom: 1.5rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .login-input {
            padding: 0.6rem;
            font-size: 0.85rem;
            border: none;
            border-radius: 8px;
            background-color: var(--card-bg);
            font-family: 'Inter', sans-serif;
            box-shadow: inset 2px 2px 4px var(--shadow-dark),
                        inset -2px -2px 4px var(--shadow-light);
            transition: all 0.2s ease;
        }

        .login-input:focus {
            outline: none;
            box-shadow: inset 1px 1px 2px var(--shadow-dark),
                        inset -1px -1px 2px var(--shadow-light),
                        0 0 0 2px var(--primary-color);
        }

        .login-button {
            padding: 0.8rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: white;
            background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Roboto', sans-serif;
        }

        .login-button:hover {
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .login-error {
            color: var(--warning-color);
            font-size: 0.8rem;
            margin-top: 0.5rem;
            display: none;
        }

        @media (max-width: 1200px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 992px) {
            .daily-summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
            }

            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
                margin-bottom: 0.8rem;
            }

            .filter-label {
                margin-bottom: 0.3rem;
            }

            .date-picker, .area-select, .wi-input {
                width: 100%;
            }

            .tabs {
                overflow-x: auto;
                white-space: nowrap;
            }

            .tab {
                padding: 0.6rem 1rem;
            }

            .daily-summary-grid {
                grid-template-columns: 1fr;
            }

            .summary-card {
                grid-template-columns: 1fr 1fr;
            }

            .summary-date-filter {
                flex-direction: column;
                align-items: flex-start;
            }

            .login-container {
                margin: 1rem;
                padding: 1.5rem;
            }
        }

        @media (max-width: 576px) {
            .summary-card {
                grid-template-columns: 1fr;
            }

            .chart-card {
                padding: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div id="login-container" class="login-container">
        <img src="https://justingps.github.io/dpr/logo.png" alt="Company Logo" class="login-logo">
        <div class="login-form">
            <input type="text" id="username" class="login-input" placeholder="Username" autocomplete="off">
            <input type="password" id="password" class="login-input" placeholder="Password">
            <button class="login-button" onclick="handleLogin()">Login</button>
            <div id="login-error" class="login-error">Invalid username or password</div>
        </div>
    </div>

    <div id="dashboard-container" class="container" style="display: none;">
        <div class="header">
            <div class="logo-container">
                <img src="https://justingps.github.io/dpr/logo.png" alt="Company Logo" class="logo">
                <div class="company-info">
                    <div><strong>CONTRACTOR:</strong> GULF PETROCHEMICAL SERVICES LLC.</div>
                    <div><strong>CLIENT:</strong> OXY - OCCIDENTAL OF OMAN INC.</div>
                    <div><strong>CONTRACT:</strong> GFSC - MASTER INTEGRATED SERVICES AGREEMENT No. 24000110790</div>
                    <div><strong>TODAY:</strong> <span id="currentDate"></span></div>
                </div>
            </div>
            <button class="logout-button" onclick="handleLogout()">Logout</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="openTab('summary')"><i class="fas fa-chart-bar"></i> Summary</div>
            <div class="tab" onclick="openTab('reports')"><i class="fas fa-file-alt"></i> Reports</div>
        </div>

        <div id="summary" class="tab-content active">
            <h1>Work Analytics Dashboard</h1>
            
            <div class="summary-date-filter">
                <span class="summary-date-label"><i class="far fa-calendar-alt"></i> Date Range:</span>
                <input type="date" id="summaryStartDate" class="date-picker" onchange="updateSummaryCharts()">
                <span>to</span>
                <input type="date" id="summaryEndDate" class="date-picker" onchange="updateSummaryCharts()">
            </div>
            
            <div id="summaryLoading" class="loading-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading Summary Data</div>
                <div class="loading-subtext">Analyzing work patterns and crew distributions</div>
            </div>
            
            <div id="summaryContent" style="display: none;">
                <div class="summary-grid">
                    <div>
                        <div class="chart-card">
                            <div class="chart-title">Daily Crew Reporting by Area</div>
                            <canvas id="crewAllocationChart"></canvas>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-title">Reporting Trend by Area</div>
                            <canvas id="crewTrendChart"></canvas>
                        </div>

                        <div class="chart-card">
                            <div class="chart-title">Top 5 Projects by Crew Utilization</div>
                            <canvas id="workGroupUtilizationChart"></canvas>
                        </div>
                    </div>
                    
                    <div>
                        <div class="chart-card">
                            <div class="chart-title">Recent Activity</div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Foremen</th>
                                        <th>Crew Size</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="recentActivity">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="reports" class="tab-content">
            <div class="filter-container">
                <div class="filter-group">
                    <span class="filter-label"><i class="far fa-calendar-alt"></i> Date:</span>
                    <input type="date" id="reportDate" class="date-picker" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <span class="filter-label"><i class="fas fa-map-marker-alt"></i> Area/Block:</span>
                    <select id="areaSelect" class="area-select" onchange="applyFilters()">
                        <option value="all">All Areas</option>
                        <option value="Safha (Block-9)">Safha (Block-9)</option>
                        <option value="Block-62">Block-62</option>
                        <option value="Other">Other</option>
                        <option value="Wadi Latham (Block-9)">Wadi Latham (Block-9)</option>
                        <option value="Infrastructure Project">Infrastructure Project</option>
                        <option value="Khamila (Bock-27)">Khamila (Bock-27)</option>
                        <option value="FRT Project">FRT Project</option>
                        <option value="Power Project">Power Project</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label"><i class="fas fa-search"></i> WI:</span>
                    <input type="text" id="wiInput" class="wi-input" placeholder="Search WI..." oninput="applyFilters()">
                </div>
            </div>
            
            <div id="reportsLoading" class="loading-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading Report Data</div>
                <div class="loading-subtext">Please wait while we fetch your reports</div>
            </div>
            
            <div id="reportsContent" style="display: none;">
                <div id="dailySummaryContainer" class="daily-summary">
                    <!-- Daily summary will be displayed here -->
                </div>
                
                <div id="reportContainer">
                    <!-- Data will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check login status on page load
        window.onload = function() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showDashboard();
            } else {
                document.getElementById('login-container').style.display = 'block';
                document.body.style.display = 'flex';
            }
        };

        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            if (username === 'admin' && password === 'admin') {
                sessionStorage.setItem('isLoggedIn', 'true');
                showDashboard();
            } else {
                errorDiv.style.display = 'block';
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('isLoggedIn');
            document.getElementById('dashboard-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').style.display = 'none';
            document.body.style.display = 'flex';
        }

        function showDashboard() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
            document.body.style.display = 'block';

            // Initialize dashboard
            const today = new Date();
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(today.getDate() - 7);
            
            document.getElementById('reportDate').valueAsDate = today;
            document.getElementById('summaryStartDate').valueAsDate = oneWeekAgo;
            document.getElementById('summaryEndDate').valueAsDate = today;
            document.getElementById('currentDate').textContent = formatDateForDisplay(today);
            
            loadData();
        }

        // Your published Google Sheets CSV URL
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSYGYKtfTtxPYNafZF8fBcJfmMXPFUbltmTC-TKE4dK-GTIicfg13FSUEtIZ-iMC6Xy2vtxV8-R4dGZ/pub?gid=1788579973&single=true&output=csv';
        
        let allData = [];
        let charts = {};
        
        function openTab(tabName) {
            // Hide all tab contents
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remove active class from all tabs
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Show the current tab and mark button as active
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            // If opening summary tab, update charts
            if (tabName === 'summary' && allData.length > 0) {
                updateSummaryCharts();
            }
        }
        
        function formatDateForDisplay(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }
        
        function loadData() {
            // Show loading state
            document.getElementById('summaryLoading').style.display = 'flex';
            document.getElementById('reportsLoading').style.display = 'flex';
            
            fetch(SHEET_URL)
                .then(response => response.text())
                .then(csvData => {
                    // Parse CSV data with improved parser
                    allData = parseCSV(csvData);
                    
                    // Hide loading and show content
                    document.getElementById('summaryLoading').style.display = 'none';
                    document.getElementById('summaryContent').style.display = 'block';
                    document.getElementById('reportsLoading').style.display = 'none';
                    document.getElementById('reportsContent').style.display = 'block';
                    
                    // Apply filters initially
                    applyFilters();
                    
                    // Update summary charts if on summary tab
                    if (document.getElementById('summary').classList.contains('active')) {
                        updateSummaryCharts();
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    document.getElementById('reportContainer').innerHTML = 
                        '<p class="no-data">Error loading data. Please try again later.</p>';
                    
                    // Hide loading even if there's an error
                    document.getElementById('summaryLoading').style.display = 'none';
                    document.getElementById('reportsLoading').style.display = 'none';
                    document.getElementById('summaryContent').style.display = 'block';
                    document.getElementById('reportsContent').style.display = 'block';
                });
        }
        
        function parseCSV(csv) {
            // Improved CSV parser that handles multi-line fields
            const lines = [];
            let currentLine = [];
            let inQuotes = false;
            let currentField = '';
            
            for (let i = 0; i < csv.length; i++) {
                const char = csv[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    currentLine.push(currentField.trim());
                    currentField = '';
                } else if (char === '\n' && !inQuotes) {
                    currentLine.push(currentField.trim());
                    lines.push(currentLine);
                    currentLine = [];
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            
            // Add the last line
            if (currentField.trim() !== '' || currentLine.length > 0) {
                currentLine.push(currentField.trim());
                lines.push(currentLine);
            }
            
            if (lines.length === 0) return [];
            
            const headers = lines[0];
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = lines[i][j] || '';
                }
                result.push(obj);
            }
            
            return result;
        }
        
        function applyFilters() {
            const selectedDate = document.getElementById('reportDate').valueAsDate;
            const selectedArea = document.getElementById('areaSelect').value;
            const wiSearch = document.getElementById('wiInput').value.trim().toLowerCase();
            
            if (!selectedDate) return;
            
            const formattedSelectedDate = formatDateForComparison(selectedDate);
            
            const filteredData = allData.filter(row => {
                if (!row.DATE) return false;
                
                // Date filtering
                const rowDate = parseSheetDate(row.DATE);
                if (!rowDate) return false;
                const formattedRowDate = formatDateForComparison(rowDate);
                if (formattedRowDate !== formattedSelectedDate) return false;
                
                // Area filtering
                if (selectedArea !== 'all' && row['AREA / BLOCK'] !== selectedArea) {
                    return false;
                }
                
                // WI number filtering (partial match)
                if (wiSearch && row['WI NO'] && !row['WI NO'].toLowerCase().includes(wiSearch)) {
                    return false;
                }
                
                return true;
            });
            
            displayData(filteredData);
        }
        
        // Parse dates from sheet (handles both "27-Mar-2025" and "2025-03-27" formats)
        function parseSheetDate(dateString) {
            if (!dateString) return null;
            
            // Try DD-MMM-YYYY format (e.g., 27-Mar-2025)
            const months = {
                'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
            };
            
            const mmmFormat = dateString.match(/^(\d{1,2})-([A-Za-z]{3})-(\d{4})$/);
            if (mmmFormat) {
                const day = parseInt(mmmFormat[1], 10);
                const month = months[mmmFormat[2]];
                const year = parseInt(mmmFormat[3], 10);
                return new Date(year, month, day);
            }
            
            // Try YYYY-MM-DD format (e.g., 2025-03-27)
            const yyyyFormat = dateString.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
            if (yyyyFormat) {
                const year = parseInt(yyyyFormat[1], 10);
                const month = parseInt(yyyyFormat[2], 10) - 1; // Months are 0-indexed
                const day = parseInt(yyyyFormat[3], 10);
                return new Date(year, month, day);
            }
            
            // Try DD/MM/YYYY format (e.g., 05/06/2025)
            const ddmmFormat = dateString.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (ddmmFormat) {
                const day = parseInt(ddmmFormat[1], 10);
                const month = parseInt(ddmmFormat[2], 10) - 1; // Months are 0-indexed
                const year = parseInt(ddmmFormat[3], 10);
                return new Date(year, month, day);
            }
            
            return null;
        }
        
        // Format date for comparison (YYYY-MM-DD)
        function formatDateForComparison(date) {
            if (!date) return '';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function displayData(data) {
            const container = document.getElementById('reportContainer');
            const summaryContainer = document.getElementById('dailySummaryContainer');
            
            if (data.length === 0) {
                container.innerHTML = '<p class="no-data">No records found for the selected filters.</p>';
                summaryContainer.innerHTML = '';
                return;
            }
            
            // Calculate daily summary by area
            const areaSummary = {};
            const selectedDate = document.getElementById('reportDate').valueAsDate;
            const formattedDate = formatDateForDisplay(selectedDate);
            
            data.forEach(row => {
                const area = row['AREA / BLOCK'] || 'Unknown';
                if (!areaSummary[area]) {
                    areaSummary[area] = {
                        permits: new Set(),
                        crewSize: new Set(),
                        foremen: new Set()
                    };
                }
                
                if (row['PERMIT NUMBER']) {
                    areaSummary[area].permits.add(row['PERMIT NUMBER']);
                }
                
                if (row['RESOURCE ID']) {
                    areaSummary[area].crewSize.add(row['RESOURCE ID']);
                }
                
                if (row['FOREMAN ID']) {
                    areaSummary[area].foremen.add(row['FOREMAN ID']);
                }
            });
            
            // Generate daily summary HTML
            let summaryHtml = `
                <h3>Daily Summary for ${formattedDate}</h3>
                <div class="daily-summary-grid">
            `;
            
            Object.entries(areaSummary).forEach(([area, stats]) => {
                summaryHtml += `
                    <div class="daily-summary-item">
                        <div class="daily-summary-area">${area}</div>
                        <div class="daily-summary-stats">
                            <div>
                                <div class="summary-label">Permits</div>
                                <div class="summary-value">${stats.permits.size}</div>
                            </div>
                            <div>
                                <div class="summary-label">Crew Size</div>
                                <div class="summary-value">${stats.crewSize.size}</div>
                            </div>
                            <div>
                                <div class="summary-label">Foremen</div>
                                <div class="summary-value">${stats.foremen.size}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add totals
            const totalPermits = Object.values(areaSummary).reduce((sum, area) => sum + area.permits.size, 0);
            const totalCrew = Object.values(areaSummary).reduce((sum, area) => sum + area.crewSize.size, 0);
            const totalForemen = Object.values(areaSummary).reduce((sum, area) => sum + area.foremen.size, 0);
            
            summaryHtml += `
                    <div class="daily-summary-item" style="background-color: #dbeafe;">
                        <div class="daily-summary-area">TOTAL</div>
                        <div class="daily-summary-stats">
                            <div>
                                <div class="summary-label">Permits</div>
                                <div class="summary-value">${totalPermits}</div>
                            </div>
                            <div>
                                <div class="summary-label">Crew Size</div>
                                <div class="summary-value">${totalCrew}</div>
                            </div>
                            <div>
                                <div class="summary-label">Foremen</div>
                                <div class="summary-value">${totalForemen}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            summaryContainer.innerHTML = summaryHtml;
            
            // Group by work description and permit number
            const groupedData = {};
            data.forEach(row => {
                const key = `${row['DESCRIPTION OF WORK']}|${row['PERMIT NUMBER']}|${row['WI NO']}|${row['FOREMAN ID']}|${row['FOREMAN NAME'] || 'Unknown'}`;
                if (!groupedData[key]) {
                    groupedData[key] = {
                        details: {
                            'FOREMAN ID': row['FOREMAN ID'],
                            'FOREMAN NAME': row['FOREMAN NAME'] || 'Unknown',
                            'WI NO': row['WI NO'],
                            'AREA / BLOCK': row['AREA / BLOCK'],
                            'DESCRIPTION OF WORK': row['DESCRIPTION OF WORK'],
                            'PERMIT NUMBER': row['PERMIT NUMBER'],
                            'VALIDATION TIME': row['VALIDATION TIME'],
                            'SUSPENSION TIME': row['SUSPENSION TIME']
                        },
                        resources: []
                    };
                }
                
                // Add all resources
                groupedData[key].resources.push({
                    'RESOURCE ID': row['RESOURCE ID'],
                    'RESOURCE DESIGNATION': row['RESOURCE DESIGNATION'] || '-',
                    'MANPOWER / EQUIPMENT': row['MANPOWER / EQUIPMENT'] || '-',
                    'TIME-IN': row['TIME-IN'],
                    'TIME-OUT': row['TIME-OUT']
                });
            });
            
            // Generate HTML
            let html = '';
            let groupCounter = 1;
            
            Object.values(groupedData).forEach(group => {
                // Count different types of resources
                const manpowerCount = group.resources.filter(r => 
                    r['MANPOWER / EQUIPMENT'] && 
                    r['MANPOWER / EQUIPMENT'].toLowerCase() === 'manpower'
                ).length;
                
                const equipmentCount = group.resources.filter(r => 
                    r['MANPOWER / EQUIPMENT'] && 
                    r['MANPOWER / EQUIPMENT'].toLowerCase() === 'equipment'
                ).length;
                
                // Count unique crew members
                const uniqueCrew = new Set(group.resources.map(r => r['RESOURCE ID']));
                
                // Find foreman (first resource with matching ID or first resource if not found)
                const foreman = group.resources.find(r => r['RESOURCE ID'] === group.details['FOREMAN ID']) || 
                               group.resources[0];
                
                html += `
                    <div class="work-group">
                        <div class="work-group-header">
                            <span class="work-group-title">Work Pogress Report - Group #${groupCounter}</span>
                            <span class="work-group-id">WI NO: ${group.details['WI NO']}</span>
                        </div>
                        
                        <div class="work-description">${group.details['DESCRIPTION OF WORK'].replace(/"/g, '')}</div>
                        
                        <div class="summary-card">
                            <div class="summary-item">
                                <div class="summary-label">Foreman ID</div>
                                <div class="summary-value">${group.details['FOREMAN ID']}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Foreman Name</div>
                                <div class="summary-value">${group.details['FOREMAN NAME']}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Area/Block</div>
                                <div class="summary-value">${group.details['AREA / BLOCK']}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Permit Number</div>
                                <div class="summary-value">${group.details['PERMIT NUMBER']}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Work Hours</div>
                                <div class="summary-value">${group.details['VALIDATION TIME']} to ${group.details['SUSPENSION TIME']}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Manpower</div>
                                <div class="summary-value">${manpowerCount}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Equipment</div>
                                <div class="summary-value">${equipmentCount}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Crew Size</div>
                                <div class="summary-value">${uniqueCrew.size}</div>
                            </div>
                        </div>
                        
                        <h3>Resource Details</h3>
                        <table class="resource-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Resource ID</th>
                                    <th>Designation</th>
                                    <th>Type</th>
                                    <th>Time-In</th>
                                    <th>Time-Out</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${group.resources.map((resource, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${resource['RESOURCE ID']}</td>
                                        <td>${resource['RESOURCE DESIGNATION']}</td>
                                        <td>${resource['MANPOWER / EQUIPMENT']}</td>
                                        <td>${resource['TIME-IN'] || '-'}</td>
                                        <td>${resource['TIME-OUT'] || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                groupCounter++;
            });
            
            container.innerHTML = html;
        }
        
        function updateSummaryCharts() {
            if (allData.length === 0) return;
            
            const startDate = document.getElementById('summaryStartDate').valueAsDate;
            const endDate = document.getElementById('summaryEndDate').valueAsDate;
            
            if (!startDate || !endDate) return;
            
            // Prepare data for charts
            const datesInRange = getDatesInRange(startDate, endDate);
            const areaCrewData = {};
            const areaTrendData = {};
            const workGroupData = {};
            
            // Initialize data structures
            datesInRange.forEach(date => {
                const dateKey = formatDateForComparison(date);
                areaTrendData[dateKey] = {};
            });
            
            // Process all data to get crew allocations and work group utilization
            allData.forEach(row => {
                const rowDate = parseSheetDate(row.DATE);
                if (!rowDate) return;
                
                const formattedRowDate = formatDateForComparison(rowDate);
                const formattedDisplayDate = formatDateForDisplay(rowDate);
                
                // Skip if date is outside our range
                if (rowDate < startDate || rowDate > endDate) return;
                
                const area = row['AREA / BLOCK'] || 'Unknown';
                const workGroupKey = `${row['WI NO']} - ${row['AREA / BLOCK'] || 'Unknown'}`;
                
                // Initialize area data if not exists
                if (!areaCrewData[area]) {
                    areaCrewData[area] = {
                        totalCrew: 0,
                        dates: {},
                        foremen: new Set()
                    };
                }
                
                // Track unique crew members per area per date
                if (!areaCrewData[area].dates[formattedRowDate]) {
                    areaCrewData[area].dates[formattedRowDate] = {
                        crewSize: new Set(),
                        foremen: new Set()
                    };
                }
                
                if (row['RESOURCE ID']) {
                    areaCrewData[area].dates[formattedRowDate].crewSize.add(row['RESOURCE ID']);
                }
                
                if (row['FOREMAN ID']) {
                    areaCrewData[area].dates[formattedRowDate].foremen.add(row['FOREMAN ID']);
                    areaCrewData[area].foremen.add(row['FOREMAN ID']);
                }
                
                // Track work group utilization
                if (!workGroupData[workGroupKey]) {
                    workGroupData[workGroupKey] = {
                        crewSize: new Set(),
                        area: row['AREA / BLOCK'] || 'Unknown',
                        wiNo: row['WI NO']
                    };
                }
                if (row['RESOURCE ID']) {
                    workGroupData[workGroupKey].crewSize.add(row['RESOURCE ID']);
                }
            });
            
            // Calculate totals and prepare trend data
            Object.keys(areaCrewData).forEach(area => {
                Object.keys(areaCrewData[area].dates).forEach(date => {
                    const crewSize = areaCrewData[area].dates[date].crewSize.size;
                    // Prepare trend data
                    if (!areaTrendData[date][area]) {
                        areaTrendData[date][area] = 0;
                    }
                    areaTrendData[date][area] += crewSize;
                });
            });
            
            // Prepare data for Daily Crew Allocation chart (stacked bar)
            const crewAllocationLabels = datesInRange.map(date => formatDateForDisplay(date));
            const crewAllocationDatasets = [];
            
            // Get top 5 areas by total crew size
            const areasByCrewSize = Object.keys(areaCrewData)
                .map(area => ({
                    name: area,
                    total: Object.keys(areaCrewData[area].dates)
                        .reduce((sum, date) => sum + areaCrewData[area].dates[date].crewSize.size, 0)
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
            
            // Create dataset for each area
            const colors = [
                'rgba(37, 99, 235, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(5, 150, 105, 0.8)',
                'rgba(217, 119, 6, 0.8)',
                'rgba(219, 39, 119, 0.8)'
            ];
            
            areasByCrewSize.forEach((area, index) => {
                const areaData = datesInRange.map(date => {
                    const dateKey = formatDateForComparison(date);
                    return areaCrewData[area.name].dates[dateKey] ? 
                        areaCrewData[area.name].dates[dateKey].crewSize.size : 0;
                });
                
                crewAllocationDatasets.push({
                    label: area.name,
                    data: areaData,
                    backgroundColor: colors[index],
                    borderColor: colors[index],
                    borderWidth: 1
                });
            });
            
            // Prepare data for Crew Trend chart (line)
            const trendLabels = datesInRange.map(date => formatDateForDisplay(date));
            const trendDatasets = [];
            
            areasByCrewSize.forEach((area, index) => {
                const trendData = datesInRange.map(date => {
                    const dateKey = formatDateForComparison(date);
                    return areaTrendData[dateKey][area.name] || 0;
                });
                
                trendDatasets.push({
                    label: area.name,
                    data: trendData,
                    borderColor: colors[index],
                    backgroundColor: colors[index],
                    borderWidth: 2,
                    tension: 0.3,
                    fill: false
                });
            });
            
            // Prepare data for Work Group Utilization chart (bar)
            const workGroupLabels = [];
            const workGroupDatasets = [];
            const topWorkGroups = Object.keys(workGroupData)
                .map(group => ({
                    name: group,
                    total: workGroupData[group].crewSize.size
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
            
            const workGroupDataValues = topWorkGroups.map(group => group.total);
            workGroupLabels.push(...topWorkGroups.map(group => group.name));
            
            workGroupDatasets.push({
                label: 'Crew Utilization',
                data: workGroupDataValues,
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 1
            });
            
            // Update recent activity table - now counting unique foremen per day
            const recentActivityData = {};
            datesInRange.forEach(date => {
                const dateKey = formatDateForComparison(date);
                recentActivityData[dateKey] = {
                    date: dateKey,
                    foremen: new Set(),
                    crewSize: new Set(),
                    active: false
                };
            });
            
            allData.forEach(row => {
                const rowDate = parseSheetDate(row.DATE);
                if (!rowDate) return;
                
                const dateKey = formatDateForComparison(rowDate);
                
                if (recentActivityData[dateKey]) {
                    if (row['FOREMAN ID']) {
                        recentActivityData[dateKey].foremen.add(row['FOREMAN ID']);
                    }
                    if (row['RESOURCE ID']) {
                        recentActivityData[dateKey].crewSize.add(row['RESOURCE ID']);
                    }
                    recentActivityData[dateKey].active = true;
                }
            });
            
            const recentActivityHtml = Object.values(recentActivityData)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(day => `
                    <tr>
                        <td>${formatDateForDisplay(new Date(day.date))}</td>
                        <td>${day.foremen.size}</td>
                        <td>${day.crewSize.size}</td>
                        <td><span class="status-indicator ${day.active ? 'status-active' : 'status-inactive'}"></span>
                            ${day.active ? 'Active' : 'No Activity'}</td>
                    </tr>
                `).join('');
            document.getElementById('recentActivity').innerHTML = recentActivityHtml;
            
            // Destroy existing charts if they exist
            if (charts.crewAllocationChart) charts.crewAllocationChart.destroy();
            if (charts.crewTrendChart) charts.crewTrendChart.destroy();
            if (charts.workGroupUtilizationChart) charts.workGroupUtilizationChart.destroy();
            
            // Create or update charts
            const ctx1 = document.getElementById('crewAllocationChart').getContext('2d');
            charts.crewAllocationChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: crewAllocationLabels,
                    datasets: crewAllocationDatasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Crew Size'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
            
            const ctx2 = document.getElementById('crewTrendChart').getContext('2d');
            charts.crewTrendChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: trendDatasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Crew Size'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
            
            const ctx3 = document.getElementById('workGroupUtilizationChart').getContext('2d');
            charts.workGroupUtilizationChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: workGroupLabels,
                    datasets: workGroupDatasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Work Group'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Total Crew Utilization'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }
        
        function getDatesInRange(startDate, endDate) {
            const dates = [];
            let currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dates;
        }
        
        function getLastNDays(n) {
            const dates = [];
            for (let i = n - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(formatDateForComparison(date));
            }
            return dates;
        }
        
        function parseTime(timeString) {
            if (!timeString) return null;
            
            const match = timeString.match(/^(\d{1,2}):(\d{2})$/);
            if (!match) return null;
            
            const hours = parseInt(match[1], 10);
            const minutes = parseInt(match[2], 10);
            
            // Create a date object with arbitrary date (we only care about time)
            const date = new Date();
            date.setHours(hours, minutes, 0, 0);
            return date;
        }
    </script>
</body>
</html>
